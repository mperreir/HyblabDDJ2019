<!DOCTYPE html>
<html>

<head>
    <!-- Load D3 from site -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>

<!-- CSS (Styling) -->
<style type="text/css">
    /* Format X and Y Axis */
    .axis path,
    .axis line {
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;
    }

    .axis text {
        font-family: sans-serif;
        font-size: 11px;
    }
</style>
<!-- End CSS (Styling) -->

<body>
    <h2>D3 Scatterplot </h2>
    <p>This is a data visualization using transitions with a scatterplot</p>
    <h4>Click on this text to update chart with new values</h4>
    <h3></h3>

    <!-- Begin D3 Javascript -->
    <script type="text/javascript">

        // Setup settings for graphic
        var canvas_width = 500;
        var canvas_height = 300;

        // Setup data
        var dataset = [];  // Initialize empty array
        var numDataPoints = 50;  // Number of dummy data points
        var maxRangeX = Math.random() * 1000;  // Get max range of new values
        var maxRangeY = 3;
        dataset = [];  // Initialize empty array
        var x = 0;
        var y = 0;
        for (var i = 0; i < numDataPoints; i++) {

            if (30 * x + 30 >= canvas_width) {
                x = 0;
                y = y + 1;
            }
            var newNumber1 = 30 * x;  // Random int for x
            var newNumber2 = y*20;  // Random int for y
            dataset.push([newNumber1, newNumber2]);  // Add new numbers to array
            x = x + 1;
        }


        // Create SVG element
        var svg = d3.select("h3")  // This is where we put our vis
            .append("svg")
            .attr("width", canvas_width)
            .attr("height", canvas_height)

        // Create Circles
        svg.selectAll("image")
            .data(dataset)
            .enter()
            .append("image")  // Add circle svg
            .attr("x", function (d) {
                return d[0];  // Circle's X
            })
            .attr("y", function (d) {  // Circle's Y
                return d[1];
            })
            .attr("xlink:href", './img/test.png')
            .attr('width', 30)
            .attr('height', 20);  // radius

        // Add to X axis
        /*svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + (canvas_height - padding) + ")")
            .call(xAxis);

        // Add to Y axis
        svg.append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(" + padding + ",0)")
            .call(yAxis);*/

        // On click, update with new data
        d3.select("h4")
            .on("click", function () {
                Promise.all([bbbb()]).then(test)
            });

        const bbbb = () => {
            var numValues = dataset.length;  // Get original dataset's length
            dataset = [];  // Initialize empty array
            var x = 0;
            var y = 0;
            var grp = [25, 10, 15];
            var num_grp = 0;
            var ind = 0;
            var prec = 0
            var save = 0
            for (var i = 0; i < numValues; i++) {
                if (grp[num_grp] == ind){
                    num_grp += 1;
                    ind = 0;
                    prec += save;
                }
                var newNumber1 = 80;  // Random int for x
                var newNumber2 = prec ;  // Random int for y
                
                save = (20 * ((grp[num_grp])/50 * 5));
                console.log(save)
                dataset.push([newNumber1, newNumber2 - newNumber2/4]);  // Add new numbers to array
                ind = ind + 1;
            }

            // Update scale domains


            // Update circles
            return new Promise((resolve, reject) => {
                svg.selectAll("image")
                    .data(dataset)  // Update with new data
                    .transition()  // Transition from old to new
                    .duration(1000)  // Length of animation
                    .each("start", function () {  // Start animation
                        d3.select(this)  // 'this' means the current element
                            .attr("xlink:href", "./img/test.png")  // Change color
                            .attr('width', 30)
                            .attr('height', 20);  // Change size
                    })
                    .delay(function (d, i) {
                        return i;  // Dynamic delay (i.e. each item delays a little longer)
                    })
                    //.ease("linear")  // Transition easing - default 'variable' (i.e. has acceleration), also: 'circle', 'elastic', 'bounce', 'linear'
                    .attr("x", function (d) {
                        return d[0];  // Circle's X
                    })
                    .attr("y", function (d) {
                        return d[1];  // Circle's Y
                    })
                    .each("end", function () {  // End animation
                        //resolve();
                    });

                // Update X Axis
                /*svg.select(".x.axis")
                    .transition()
                    .duration(1000)
                    .call(xAxis);

                // Update Y Axis
                svg.select(".y.axis")
                    .transition()
                    .duration(100)
                    .call(yAxis);*/
            });
        };
        function test() {
            var p = new Promise((resolve, reject) => {
                d3.selectAll("image")  // 'this' means the current element
                    .transition()
                    .duration(500)
                    .remove()
                    .each("end", function () {
                        resolve();
                    });
            });

            p.then(test2)
        }

        function test2() {
            var svg = d3.select("svg")  // This is where we put our vis
            // Create Circles
            // Update scale domains
            dataset = [[80, 0, 0], [80, 1, 50], [80, 2, 70]];
            var grp = [25, 10, 15];
            svg.selectAll("image")
                .data(dataset)
                .enter()
                .append("image")  // Add circle svg
                .attr("x", function (d) {
                    return d[0];  // Circle's X
                })
                .attr("y", function (d) {  // Circle's Y
                    return d[2];
                })
                .attr("xlink:href", './img/test.png')
                .attr('width', function(d){
                    return 30 *((grp[d[1]])/50 * 5);
                })
                .attr('height', function(d){
                    console.log(20 *((50-grp[d[1]])/50 * 5))
                    return  20 *((grp[d[1]])/50 * 5);
                });  // radius

            // Update X Axis
            /*svg.select(".x.axis")
                .transition()
                .duration(1000)
                .call(xAxis);

            // Update Y Axis
            svg.select(".y.axis")
                .transition()
                .duration(100)
                .call(yAxis);*/
        }

    </script>
</body>

</html>